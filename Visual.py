import streamlit as st
import requests
from requests.exceptions import RequestException
import pandas as pd

cluster_names = {
    "0": "–ü–æ–ª–∏—Ç–∏–∫–∞",
    "1": "–≠–∫–æ–Ω–æ–º–∏–∫–∞",
    "2": "–°–ø–æ—Ä—Ç",
    "3": "–ù–∞—É–∫–∞",
    "4": "–ö—É–ª—å—Ç—É—Ä–∞",
    "5": "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
    "6": "–ú–∏—Ä",
    "7": "–ó–¥–æ—Ä–æ–≤—å–µ",
    "8": "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
    "9": "–ü—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è"
}

API_URL = "http://localhost:8000"  # –ê–¥—Ä–µ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ API

st.set_page_config(page_title="–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π", page_icon="üì∞")

st.title("–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º")
st.markdown(
    """
    –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –∏ –ø–æ–ª—É—á–∏—Ç—å –µ—ë –∫–∞—Ç–µ–≥–æ—Ä–∏—é (—Ç–µ–º–∞—Ç–∏–∫—É), 
    –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –º–∞—à–∏–Ω–Ω—ã–º –æ–±—É—á–µ–Ω–∏–µ–º. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–¥–µ–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞, –æ–±—É—á–µ–Ω–Ω—ã–µ 
    –Ω–∞ –∫–æ—Ä–ø—É—Å–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
    """
)

# –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏
news_text = st.text_area(
    "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏",
    height=200,
    placeholder="–ü—Ä–∏–º–µ—Ä: –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è –∫—É–ø–∏–ª–∞ –ø—Ä–∞–≤–∞ –Ω–∞ –∞—Ä—Ö–∏–≤ —Å–æ–≤–µ—Ç—Å–∫–æ–π –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∏–∫–∏..."
)

if st.button("–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å"):
    if news_text.strip():
        try:
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API
            response = requests.post(
                f"{API_URL}/predict",
                json={"text": news_text},
                headers={"Content-Type": "application/json"},
                timeout=10
            )

            if response.status_code == 200:
                result = response.json()

                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                st.success(f"–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: **{result['cluster_name']}**")
                confidence = result.get('confidence')
                if confidence is not None:
                    st.write(f"**–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:** {confidence:.2%}")
                else:
                    st.write("**–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:** –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ")

                with st.expander("–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏"):
                    st.write(f"**–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏:**\n{news_text}")
                    st.write(f"**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å:** {result.get('model_used')}")

                    if 'probabilities' in result and result['probabilities']:
                        st.subheader("üìä –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:")
                        for cluster, prob in result['probabilities'].items():
                            name = cluster_names.get(cluster)
                            st.write(f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è - {name}: {prob:.2%}")

            else:
                st.error(f"–û—à–∏–±–∫–∞ –æ—Ç API: {response.status_code} - {response.text}")

        except RequestException as e:
            st.error(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: {str(e)}")
    else:
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")


# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –ü—Ä–∏–º–µ—Ä—ã –Ω–æ–≤–æ—Å—Ç–µ–π
if st.checkbox("üìñ –ü—Ä–∏–º–µ—Ä—ã –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ –¥–∞—Ç–∞—Å–µ—Ç–∞"):
    try:
        sample_news = [
            {
                "title": "–í –ø—è—Ç–Ω–∏—Ü—É –æ–∫–æ–ª–æ 15 —á–∞—Å–æ–≤ –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –≤–∑–ª–æ–º —Å–∞–π—Ç–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ ""–†–æ—Å–ë–∏–∑–Ω–µ—Å–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥"". –ö–∞–∫ —Å–æ–æ–±—â–∞–µ—Ç —Å–∞–º–æ –†–ë–ö, ""–≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç—ã"" –≤–º–µ—Å—Ç–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –Ω–∞ —Å–∞–π—Ç–µ –±—ã–ª –ø–æ–º–µ—â–µ–Ω —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∏–ª–µ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∏—Å—Ç—Å–∫–∏—Ö –ª–∏—Å—Ç–æ–≤–æ–∫ —á–µ—á–µ–Ω—Å–∫–∏—Ö –±–æ–µ–≤–∏–∫–æ–≤. –í –ª–∏—Å—Ç–æ–≤–∫–µ, –≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –≥–æ–≤–æ—Ä–∏—Ç—Å—è: ""–ß–µ—á–µ–Ω—Å–∫–∏–µ –≤–æ–æ—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–∏–ª—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –≤–æ–π–Ω—É –ø–æ –≤—Å–µ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ß–µ—á–Ω–∏, –¥–æ–±–∏–≤–∞—è –æ—Å—Ç–∞—Ç–∫–∏ —Ä—É—Å—Å–∫–∏—Ö –∞–≥—Ä–µ—Å—Å–æ—Ä–æ–≤. –£ –Ω–∞—Å –µ—Å—Ç—å —Å–∏–ª—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–æ–π–Ω—É –∏ –Ω–∞ –≤—Å–µ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–æ—Å—Å–∏–∏, –∫–∞–∫ —É–∂–µ –∑–∞—è–≤–∏–ª"
            },
            {
                "title": "–° –∫–æ—Å–º–æ–¥—Ä–æ–º–∞ ""–ë–∞–π–∫–æ–Ω—É—Ä"" –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω –∑–∞–ø—É—Å–∫ —Ä–∞–∫–µ—Ç—ã-–Ω–æ—Å–∏—Ç–µ–ª—è ""–ü—Ä–æ—Ç–æ–Ω-–ö"" —Å –±–ª–æ–∫–æ–º –∏–∑ –¥–≤—É—Ö —Å–ø—É—Ç–Ω–∏–∫–æ–≤ —Å–≤—è–∑–∏ ""–Ø–º–∞–ª-100"" –∏ ""–Ø–º–∞–ª-100–ú"". –û–± —ç—Ç–æ–º –†–ò–ê ""–ù–æ–≤–æ—Å—Ç–∏"" —Å–æ–æ–±—â–∏–ª–∏ –≤ –ø—Ä–µ—Å—Å-—Å–ª—É–∂–±–µ —Ä–∞–∫–µ—Ç–Ω—ã—Ö –≤–æ–π—Å–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è. –°–µ–≥–æ–¥–Ω—è —É—Ç—Ä–æ–º —Å–ø—É—Ç–Ω–∏–∫–∏ —Å–≤—è–∑–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–≤–µ–¥–µ–Ω—ã –Ω–∞ –≥–µ–æ—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—É—é –æ—Ä–±–∏—Ç—É. –í—á–µ—Ä–∞—à–Ω–∏–π –∑–∞–ø—É—Å–∫ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω –ø–æ—Å–ª–µ –¥–≤—É—Ö–º–µ—Å—è—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞, –≤—ã–∑–≤–∞–Ω–Ω–æ–≥–æ –∞–≤–∞—Ä–∏–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ä–∞–∫–µ—Ç—ã —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —Ä–∞–∑–±–∏—Ä–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –º–µ–∂–¥—É –†–æ—Å—Å–∏–µ–π –∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–æ–º."
            },
            {
                "title": "–í –≠—Å—Ç–æ–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∫—Ä—É–ø–Ω–µ–π—à–µ–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —á–µ—Ç—ã—Ä–µ –≥–æ–¥–∞ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ –±–∞–Ω–∫–∞. –í –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤–µ—á–µ—Ä–æ–º –≤ —Ü–µ–Ω—Ç—Ä–µ –¢–∞–ª–ª–∏–Ω–∞ —Ç—Ä–æ–µ –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫–æ–≤ –Ω–∞–ø–∞–ª–∏ –Ω–∞ –ø—É–Ω–∫—Ç –æ–±–º–µ–Ω–∞ –≤–∞–ª—é—Ç—ã ""–Æ—Ö–∏—Å–±–∞–Ω–∫–∞"". –û–Ω–∏ –ø–æ—Ö–∏—Ç–∏–ª–∏ –≤ –æ–±—â–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ–∫–æ–ª–æ 15 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∫—Ä–æ–Ω (–º–∏–ª–ª–∏–æ–Ω –¥–æ–ª–ª–∞—Ä–æ–≤ –°–®–ê). –ü–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º —ç—Å—Ç–æ–Ω—Å–∫–æ–π –ø–æ–ª–∏—Ü–∏–∏, –≥—Ä–∞–±–∏—Ç–µ–ª–∏ –∏–∑–±–∏–ª–∏ –∏ —Å–≤—è–∑–∞–ª–∏ –∂–µ–Ω—â–∏–Ω—É-–∫–∞—Å—Å–∏—Ä–∞, –∑–∞—Ç–µ–º –∑–∞–∫—Ä—ã–ª–∏ –µ–µ –≤ –ø–æ–¥—Å–æ–±–Ω–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏, –æ—Ç–∫—É–¥–∞ –æ–Ω–∞ —Å–º–æ–≥–ª–∞ –≤—ã–±—Ä–∞—Ç—å—Å—è –ª–∏—à—å —Å–ø—É—Å—Ç—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. –ü—Ä–∏–±—ã–≤—à–∏–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª –∫–∞—Å—Å–∏—Ä–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ –æ—Ö—Ä–∞–Ω–Ω–æ–π —Ñ–∏—Ä–º—ã –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π –Ω–∞ –º–µ—Å—Ç–µ –Ω–µ –∑–∞—Å—Ç–∞–ª–∏."
            }
        ]
        st.subheader("–ü—Ä–∏–º–µ—Ä—ã –Ω–æ–≤–æ—Å—Ç–µ–π:")
        for news in sample_news:
            st.markdown(f"**–ù–∞–∑–≤–∞–Ω–∏–µ:** {news['title']}")
    except Exception as e:
        st.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –Ω–æ–≤–æ—Å—Ç–µ–π: {str(e)}")